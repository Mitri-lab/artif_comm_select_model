# Artificial community selection models
This repository contains the code for the simulations included in "Novel artificial selection method improves function of simulated microbial communities" https://doi.org/10.1101/2023.01.08.523165

It also includes the data that was generated by this code and the scripts to generate figures and statistical analyses.

## About
The code concerns artifical selection of (simulated) microbial communities ... It is written in python ... 

## Prerequisites
Python 3 with [scpiy](https://scipy.github.io/devdocs/dev/), [numpy](https://numpy.org/doc/stable/reference/index.html), [pandas](https://pandas.pydata.org/docs/user_guide/index.html) and [matplotlib](https://matplotlib.org/). Code tested with python 3.13, scipy 1.15.3, numpy 2.2.5, pandas 2.2.3 and matplotlib 3.10.0 in May 2025. The easiest installation is via the conda environment described in env_bcb.yml.

## Installation
No installation required for the simulation code itself. To install the required python libraries, consider installing [conda](https://www.anaconda.com/docs/getting-started/miniconda/install) for easier package management. Once installed, set up the python evironment from the file as  
> conda env create -f env_bcb.yml
Once created, activate the environment as
> conda activate env_bcb

## Usage

## Individual-based model (IBM)
### Directory structure
The directory ibm contains four directories. Data for plotting is found in ibm/data/ and the plotting scripts in ibm/scripts_plots, organized per figure of the manuscript. The main version of the code saves more data than might be needed, and the script in ibm/scripts_to_remove_unnecessary_content can be used to clean up after a run.

The modelling scripts are found in ibm/scripts_to_generate_data
- main_model 
- - Python script for the main model
- - Script: 211018_main_model_unix.py
- all_possible_combinations_of_species
- - Simulates one round of growth of all possible combinations of the ancestral species, to be able to rank the degadation of these and evolved communities.
- - Script: 211005_model_test_all_coms.py
- run_evolved_communities_with_ancestral_species
- - Runs several rounds of dilution of evolved communities, but with ancestral (non-evolved) strains of the constituent species. The communities are seeded with ancestral strains of the same species as the evolved communities, in the same proportions, in order to disentangle effects of evolving strains from effects of community composition. 
- - Script: 211119_communities_from_coms_last_round_with_ancestral_sp.py
- run_monocultures_from_species_in_evolved_communities
- - Monocultures of evolved strains in selected communities
- - Script: 211110_monocultures_from_coms_last_round.py
- sensitivity_analysis_tubes_subsamples_invasion_bottleneck
- - The directory contains several scripts for sensitivity analysis, how the results change with the number of species and communities, the number of tubes with invasion and the size of the dilution bottleneck.
- - Scripts: 211018_model_strains_poisson_invasion.py, 211018_model_strains_poisson_tubes.py, 211018_model_strains_poisson_species.py, 211018_model_strains_poisson_bottleneck.py, 
- transfer_best_communities_without_selection
- - Simulates a few rounds of growth and transfer (without additional selection!) of the top communites, in order to see how they stabilize without the selection treatment.
- - Scripts: 210821_transfer_evoved_coms_no_u.py and 210821_transfer_evoved_coms_no_u_ancestral.py 

### How to use
#### Main model
Configuration:
Modify the number of species, communities, species per community and other experimental parameters. Specify the output directory.

Run the main model for a single random seed as 
> python 211018_main_model_unix.py $seed > errors_main_$seed.txt &

or in parellel for a number of seeds as 
> for seed in {22..26}
> do
>     nohup nice -n 10 python 221018_main_model_unix.py $seed > errors_main_$seed.txt &
>     sleep 1 
> done

#### All communities 
Config: Define the random seed, the number of species, the length of the simulation, the number and concentration of nutrients and toxic compounds. 
Run as
> python 211005_model_test_all_coms.py

#### Transfer best communities without selection
Config: For best communities after selection, specify the random seed, the propagation methods of interest and the path to the data. For simulating the growth and transfer of communities with the same community composition as the best communities after selection, but consisting of _ancestral_ species.
> python 210821_transfer_evoved_coms_no_u.py

and 
> python 210821_transfer_evoved_coms_no_u_ancestral.py


#### Sensitivity analysis 
Config: For either sensitivity analysis, define the main community size (the number of tubes, "N_comms", default: 21), the parameters for species growth, the length of the growth period and the propagation methods (list_prop=['d3','d3',...]) the treatments (list_treat=['s','r',...]) of interest. Define the number of repeats for each seed. The conditions should be the same as the ones used for the simulations. For each condition, they will be run one after another. 
- Number of tubes: Define the desired community sizes.
- Invasion fraction: Define the fraction of tubes with migration ("f_migr") 
- Reduced number of species: Define the subsample sizes, i.e. the number of species to randomly take from the initial metacommunity (default: 15 species) as well as the number of repeats of the subsampling process.
- Bottleneck size: The transfer bottleneck depends on the propagation method, being ca 10 cells in disassembly, and 5% of the tube in the other methods. Define the multiplier "d_factor" as 0.5, 2, ... etc to run each condition with the modified bottleneck. 

Run the full sensitivity analysis as
> for seed in {22..26}
> do
>     nohup nice -n 10 python 211018_model_strains_poisson_tubes.py $seed > errors_tubes$seed.txt &
>     nohup nice -n 10 python 211018_model_strains_poisson_invasion.py $seed > errors_invasion$seed.txt & 
>     nohup nice -n 10 python 211019_model_reduce_species_labcompCORRECTED.py $seed > errors_species$seed.txt & 
>     nohup nice -n 10 python 211025_model_strains_poisson_bottleneck_labcomp.py $seed > errors_bottleneck.txt &
>     sleep 1
> done



## ODE model
Simulate the model and selection method(s) by modifying the experimental parameters in casepars.py and selsimsettings.py and the model parameters for microbial growth etc in growthpars.py. Then, run with python (version >3.7) and the random seed 12345 as 
> python SimselReps_Init.py 12345

or for a round of seeds as 
> for seed in {22..26}
> do
>     nohup nice -n 10 python SimselReps_Init.py $seed &
> done

The program could take up to 8h to run the standard settings (50 rounds of selection, 21 communities of 4 species chosen from a pool of 15) on a regular desktop or laptop computer.

## Contributors
All code for the IBM by Pablo Guridi-Fernández. All ODE code by Björn Vessman. Code for plots and figures by PGF, BV and Sara Mitri. Project conception by BV, SM and Flor Inés Arias-Sánchez. 